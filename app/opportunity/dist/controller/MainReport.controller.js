sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/ui/model/FilterType","../model/formatter","sap/ui/core/library"],function(e,t,o,r,a,i,s,n,l,u){"use strict";var c=u.ValueState,p={valueState:c.None,valueStateText:""};return e.extend("opportunity.opportunity.controller.MainReport",{formatter:l,onInit:function(){this.getView().setModel(new r({isFavourite:false}),"favModel");var e=this.getView().getModel("favModel");var t=this.getView();t.setModel(new r({}),"viewModel");t.setModel(new sap.ui.model.json.JSONModel({}),"localModel");t.setModel(new sap.ui.model.json.JSONModel(p),"valueState")},_getText:function(e,t){return this.getOwnerComponent().getModel("i18n").getResourceBundle().getText(e,t)},onSearch:function(e){var t=[];var o=e.getSource().getValue();if(o&&o.length>0){var t=[new a({filters:[new a({path:"marketUnit",operator:i.Contains,value1:o,caseSensitive:false}),new a({path:"account",operator:i.Contains,value1:o,caseSensitive:false}),new a({path:"topic",operator:i.Contains,value1:o,caseSensitive:false}),new a({path:"status",operator:i.Contains,value1:o,caseSensitive:false}),new a({path:"primaryContact",operator:i.Contains,value1:o,caseSensitive:false}),new a({path:"ssa",operator:i.Contains,value1:o,caseSensitive:false}),new a({path:"opportunityClosedQuarter",operator:i.Contains,value1:o,caseSensitive:false})],and:false})]}var r=this.byId("mySmartTable").getTable();var s=r.getBinding("items");s.filter(t,n.Application)},onListItemPress:function(e){var t=e.getSource().getBindingContext().getObject();var o=sap.ui.core.UIComponent.getRouterFor(this);o.navTo("ObjectPage",{opportunityID:t.opportunityID});var r=this.getOwnerComponent().getModel("userModel");r.setProperty("/opportunityID",t.opportunityID)},onWizardDialogPress:function(e){this.resetValueState();var t=this;t.getView().setBusy(true);if(!this._oDialog){this._oDialog=o.load({name:"opportunity.opportunity.view.fragments.WizardDialog",controller:this})}this._oDialog.then(function(e){t.getView().addDependent(e);e.open();t.onReadTopics();t.onReadDeliverables();var o=sap.ui.getCore().byId("TopicFilters");var r=o.getBindingInfo("content").template;o.bindAggregation("content",{path:"/opportunityTopicsVH",template:r,sorter:new sap.ui.model.Sorter("topic",false)});o.getBindingInfo("content").binding.refresh();var a=sap.ui.getCore().byId("DeliverablesFilters");var i=a.getBindingInfo("content").template;a.bindAggregation("content",{path:"/opportunityDeliverablesVH",template:i,sorter:new sap.ui.model.Sorter("deliverable",false)});a.getBindingInfo("content").binding.refresh()})},onSaveWizardPress:function(e){var t=this;var o=this.getView().getModel("viewModel");var r=o.getData();if(r.account&&r.marketUnit){this.resetValueState();t.getView().setBusy(true);var a,i,n,l;l=(new Date).toISOString().split("T")[0];if(r.opportunityStartDate)a=new Date(r.opportunityStartDate).toISOString().split("T")[0];if(r.opportunityDueDate)i=new Date(r.opportunityDueDate).toISOString().split("T")[0];if(r.opportunityInCRM)n="Yes";else n="No";var u=sap.ui.getCore().byId("segmentedStatus").getSelectedKey();var c=[];var p=sap.ui.getCore().byId("TopicFilters").getContent();p.forEach(e=>{if(e.getPressed()){var t={topic:e.getText()};c.push(t)}});var g=[];var d=sap.ui.getCore().byId("DeliverablesFilters").getContent();d.forEach(e=>{if(e.getPressed()){var t={deliverable:e.getText()};g.push(t)}});const o=["January","February","March","April","May","June","July","August","September","October","November","December"];const S=new Date;var v=o[S.getMonth()];var f=0;var y=0;var h=0;if(r.adoption)f=r.adoption;if(r.consumption)y=r.consumption;if(r.progress)h=r.progress;var m={account:r.account,topic:r.topic,marketUnit:r.marketUnit,opportunityStartDate:a,opportunityStartDate:i,opportunityValue:r.opportunityValue,opportunityInCRM:n,source:r.source,ssa:r.ssa,clientContactPerson:r.clientContactPerson,status:u,primaryContact:r.primaryContact,opportunityCreatedQuarter:r.opportunityCreatedQuarter,opportunityClosedQuarter:r.opportunityClosedQuarter,priority:r.priority,noteDate:l,noteText:r.noteText,progress:h,adoption:f,consumption:y,valueMonth:v,valueYear:(new Date).getFullYear().toString(),maturity:[{topic:"Overall BTP Knowledge"},{topic:"Integration"},{topic:"Governance"},{topic:"Extension"},{topic:"Data"},{topic:"Clean Core"},{topic:"Automation / AI"},{topic:"Analytics"}],topics:c,deliverables:g};var w=this.getView().getModel();w.create("/opportunityHeader",m,{success:function(o,r){s.show("New Opportunity created!");t.onCloseWizardPress(e);t.getView().setBusy(false)},error:function(e){t.getView().setBusy(false);sap.m.MessageBox.error("Opportunity could not be created. Double check your input.")}})}else this.ValueStateMethod()},onSubmitTopic:function(e){var o=this;var r=sap.ui.getCore().byId("topicInput");var a=r.getValue();var i=this.getView().getModel("localModel").getData().topics;if(a!=""&&r!=null){this.resetValueState();t.warning("Are you sure you want to post the topic "+a+" to the DataBase? This action is not reversible.",{actions:[t.Action.OK,t.Action.CANCEL],emphasizedAction:t.Action.OK,onClose:function(e){if(e===t.Action.OK){var n=i.some(e=>e.topic.toUpperCase()===a.toUpperCase());var l={topic:a};o.getView().setBusy(true);var u=o.getView().getModel();u.create("/opportunityTopicsVH",l,{success:function(e,t){s.show("New topic posted!");o.onCancelDialogPress();r.setValue("");o.getView().setBusy(false)},error:function(e){o.getView().setBusy(false);t.error("Topic could not be posted. Please check your input.")}})}else{r.setValue("");o.getView().setBusy(false)}}})}else this.ValueStateMethod()},onPostNewItem:function(){var e=this;var o={marketUnit:"France"};var r=e.getView().getModel();r.create("/opportunityMarketUnitVH",o,{success:function(e,t){s.show("New topic posted!")},error:function(e){t.error("Topic could not be posted. Please check your input.")}})},onSubmitDeliverable:function(e){var o=this;var r=sap.ui.getCore().byId("deliverableInput");var a=r.getValue();var i=this.getView().getModel("localModel").getData().deliverables;if(a!=""&&r!=null){this.resetValueState();t.warning("Are you sure you want to post the deliverable "+a+" to the DataBase? This action is not reversible.",{actions:[t.Action.OK,t.Action.CANCEL],emphasizedAction:t.Action.OK,onClose:function(e){if(e===t.Action.OK){var i={deliverable:a};o.getView().setBusy(true);var n=o.getView().getModel();n.create("/opportunityDeliverablesVH",i,{success:function(e,t){s.show("New deliverable posted!");o.onCancelDialogPress();r.setValue("");o.getView().setBusy(false)},error:function(e){o.getView().setBusy(false);t.error("Deliverable could not be posted. Please check your input.")}})}else{r.setValue("");o.getView().setBusy(false)}}})}else this.ValueStateMethod()},onSelectAllTopicsPress:function(e){sap.ui.getCore().byId("TopicFilters").getContent().forEach(function(e){var t=e.getPressed();e.setPressed(!t)})},onSelectAllDeliverablesPress:function(e){sap.ui.getCore().byId("DeliverablesFilters").getContent().forEach(function(e){var t=e.getPressed();e.setPressed(!t)})},onCloseWizardPress:function(e){var t=sap.ui.getCore().byId("myWizardDialog");t.close();var o=sap.ui.getCore().byId("WizardDialog");o.setCurrentStep("WizardStep1");this.getView().getModel("viewModel").setData({});this.getView().setBusy(false)},onCRMCheckboxSelect:function(e){var t=e.getSource();var o=t.getSelected();var r=o?"Yes":"No";t.setText(r)},onFullScreenButtonPress:function(e){var t=e.getSource().getParent().getParent();var o=e.getSource().getPressed();if(o){t.setContentWidth("100%");t.setContentHeight("100%");e.getSource().setIcon("sap-icon://exit-full-screen");sap.ui.getCore().byId("wizardRTE").setHeight("700px")}else{t.setContentWidth("1000px");t.setContentHeight("700px");e.getSource().setIcon("sap-icon://full-screen");sap.ui.getCore().byId("wizardRTE").setHeight("350px")}},onPreviousStep:function(e){sap.ui.getCore().byId("WizardDialog").previousStep()},onToggleInCRM:function(e){var t=e.getSource().getPressed();var o=t?"Yes":"No";e.getSource().setText(o);var r=t?"Yes":"";var s=new a("opportunityInCRM",i.Contains,r);var n=this.getView().byId("mainTable");n.getBinding("items").filter(s)},onEditTable:function(e){var t=this.getView().byId("mySmartTable").getTable();var o=e.getSource();var r=o.getPressed();if(r){o.setIcon("");o.setText("Cancel");t.setMode("Delete")}else{o.setIcon("sap-icon://edit");o.setText("Edit");t.setMode("None")}},onDeleteTableItem:function(e){var t=e.mParameters.listItem.getBindingContext().getObject().account;var o=this.getView().byId("mySmartTable");var r=e.mParameters.listItem.getBindingContext().sPath;var a=o.getModel();sap.m.MessageBox.warning("Are you sure you want to delete the opportunity '"+t+"'?",{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){a.remove(r,{success:function(){sap.m.MessageToast.show("Item deleted successfully.")},error:function(){sap.m.MessageToast.show("Failed to delete item.")}})}}})},onBeforeRebindTable:function(e){var t=e.getParameter("bindingParams");var o=this.getView().byId("smartFilterBar");var r=function(e){var t=e.getProperty("marketUnit");return{key:t}};var i=new sap.ui.model.Sorter("marketUnit",true,r);t.sorter.push(i);this.addFiltersForSelectedItems(e,"marketUnit");this.addFiltersForSelectedItems(e,"topic");this.addFiltersForSelectedItems(e,"primaryContact");this.addFiltersForSelectedItems(e,"status");this.addFiltersForSelectedItems(e,"opportunityCreatedQuarter");this.addFiltersForSelectedItems(e,"opportunityClosedQuarter");this.addFiltersForSelectedItems(e,"priority");this.addFiltersForSelectedItems(e,"ssa");var s=o.getControlByKey("opportunityInCRM").getState();var n=s?"Yes":"No";if(n==="Yes"){t.filters.push(new a("opportunityInCRM",sap.ui.model.FilterOperator.EQ,"Yes"))}},addFiltersForSelectedItems:function(e,t){var o=this.getView().byId("smartFilterBar");var r=e.getParameter("bindingParams");var i=o.getControlByKey(t)?.getSelectedItems()||[];i.forEach(function(e){r.filters.push(new a(t,sap.ui.model.FilterOperator.EQ,e.getText()))})},onClearSmartFilterBar:function(e){var t=e.getSource();e.getParameters()[0].selectionSet.forEach(e=>{if(e.removeAllSelectedItems){e.removeAllSelectedItems(true)}});t.getControlByKey("opportunityInCRM").setState(false);s.show("All Cleared!")},onDialogOpen:function(e){this.resetValueState();var t=this;if(!this._pDialog){this._pDialog=o.load({name:e,controller:this}).then(function(e){t.getView().addDependent(e);e.setEscapeHandler(function(){t.onCloseDialog()});return e})}this._pDialog.then(function(e){e.open()})},onCancelDialogPress:function(e){this._pDialog.then(function(e){e.close();e.destroy()});this._pDialog=null},onAddTopicPress:function(){this.onDialogOpen("opportunity.opportunity.view.fragments.addFragments.AddTopic")},onAddDeliverablePress:function(){this.onDialogOpen("opportunity.opportunity.view.fragments.addFragments.AddDeliverable")},onFavoriteToolbarPress:function(e){var t=e.getSource();var o=t.getPressed();if(o){t.setIcon("sap-icon://favorite")}else t.setIcon("sap-icon://unfavorite");var r=[];var s=e.getSource().getPressed();if(s){var r=[new a({filters:[new a({path:"isFavorite",operator:i.EQ,value1:true})],and:false})]}var l=this.byId("mySmartTable").getTable();var u=l.getBinding("items");u.filter(r,n.Application)},onFavoritePress:function(e){var t=this;var o=e.getSource();var r=o.getBindingContext();var a=r.getPath();var i=o.getBindingContext().getObject();var s=i.isFavorite;if(s===true){s=false;t.postFavouriteCustomer(s,i,a)}else{s=true;t.postFavouriteCustomer(s,i,a)}},postFavouriteCustomer:function(e,t,o){var r=this;if(e===true){t.isFavorite=true}else{t.isFavorite=false}var a=this.getView().getModel();a.update(o,t,{success:function(){var o="";if(e===true){o="'"+t.account+"' added to favorites"}else{o="'"+t.account+"' removed from favorites"}s.show(o)},error:function(e){s.show(e.message)}})},onDeleteTopic:function(){var e=this;var o=this.getView().getModel();e.getView().setBusy(true);var o=e.getView().getModel();o.create("/opportunitySubTaskStatus",oPayload,{success:function(t,o){s.show("New topic posted!");e.getView().setBusy(false)},error:function(o){e.getView().setBusy(false);t.error("Topic could not be posted. Please check your input.")}})},onReadTopics:function(){var e=this;e.getView().setBusy(true);var t=e.getView().getModel("localModel");var o=e.getView().getModel();o.read("/opportunityTopics",{urlParameters:{$orderby:"topic"},success:function(e){var o=e.results;t.setProperty("/topics",o)}.bind(this),error:function(e){console.log(e)}})},onReadDeliverables:function(){var e=this;e.getView().setBusy(true);var t=e.getView().getModel("localModel");var o=e.getView().getModel();o.read("/opportunityDeliverables",{urlParameters:{$orderby:"deliverable"},success:function(o){var r=o.results;t.setProperty("/deliverables",r);e.getView().setBusy(false)}.bind(this),error:function(t){console.log(t);e.getView().setBusy(false)}})},onFavoriteValueDriverPress:function(e){var t=this;var o=e.getSource();var r=this.getOwnerComponent().getModel("UserModel");var a=o.getBindingContext();var i=a.getPath();var s=sap.ui.getCore().byId("GoalCatalogTable").getModel().getProperty(i);var n=s.isFavourite;var l=s.valueDriverID;var u=s.valueDriverDescription;var c=r.getProperty("/username");if(n===true){console.log("Unfavorite");n=false;t.postFavouriteValueDriver(l,n,c,u)}else{console.log("Favourite");n=true;t.postFavouriteValueDriver(l,n,c,u)}},onBeforeExportOpportunities:function(e){var t=e.getParameter("exportSettings").workbook;t.columns.unshift({property:"marketUnit",label:"Market Unit"})},ValueStateMethod:function(e){var t=this.getView().getModel("valueState");s.show("Please fill all mandatory fields");t.setProperty("/valueState",c.Error);t.setProperty("/valueStateText","This field is mandatory")},resetValueState:function(e){var t=this.getView().getModel("valueState");t.setProperty("/valueState",c.None);t.setProperty("/valueStateText","")},onChangeValueState:function(e){var t=e.mParameters.newValue;if(t)this.resetValueState()}})});