sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/ui/core/message/Message","sap/m/MessageToast","sap/ui/core/ValueState","sap/ui/model/FilterType","../model/formatter","sap/ui/core/library"],function(e,t,a,o,n,s,i,r,l,c,u,p,d){"use strict";var c=d.ValueState,g={valueState:c.None,valueStateText:""};return e.extend("opportunity.opportunity.controller.TasksReport",{formatter:p,onInit:function(){var e=new o({});this.getView().setModel(e,"AddTaskModel");sap.ui.core.UIComponent.getRouterFor(this).getRoute("TasksReport").attachPatternMatched(this._onRoutePatternMatched,this);var t=new o({});this.getView().setModel(t,"actionItemModel");this.getView().setModel(new sap.ui.model.json.JSONModel(g),"valueState")},onReadTasksData:function(){var e=this.getView().getModel();var t=this.getView().getModel("actionItemModel");e.read("/opportunityActionItems",{urlParameters:{$expand:"subTasks"},success:function(e){var a=e.results;var o=[];for(var n=0;n<a.length;n++){var s=a[n].subTasks.results;for(var i=0;i<s.length;i++){o.push(s[i])}}t.setProperty("/actionItems",a);t.setProperty("/subTasks",o)}.bind(this),error:function(e){console.log(e)}})},_onRoutePatternMatched:function(e){this.onReadTasksData()},onBeforeRebindTaskTable:function(e){var t=e.getParameter("bindingParams");var a=function(e){var t;t=e.getProperty("actionCustomer");return{key:t}};var o=new sap.ui.model.Sorter("actionCustomer",false,a);t.sorter.push(o)},onDeleteTableItem:function(e){var t=this.getView().byId("myTaskTable");var a=t.getTable().getSelectedItems();if(a.length===0){sap.m.MessageToast.show("Select at least one task to delete");return}var o=t.getModel();sap.m.MessageBox.warning("Are you sure you want to delete the selected tasks?",{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){for(var t=a.length-1;t>=0;t--){var n=a[t].getBindingContext().getPath();o.remove(n,{success:function(){sap.m.MessageToast.show("Task deleted successfully.")},error:function(){sap.m.MessageToast.show("Failed to delete task.")}})}}}})},onAddToDoTablePress:function(){var e=this;this.onDialogOpen("opportunity.opportunity.view.fragments.addFragments.AddToDoTask")},onSubmitNewTask:function(e){var t=this;var a=this.getView().getModel("AddTaskModel");var o=a.getData();var n=sap.ui.getCore().byId("accountComboBox").getSelectedItem();if(n){if(o.actionTask&&o.actionTitle){var s=n.getText();this.resetValueState();var i;if(o.actionDueDate)i=new Date(o.actionDueDate).toISOString().split("T")[0];var r;if(o.actionPriority==="High")r=1;else if(o.actionPriority==="Medium")r=2;else if(o.actionPriority==="Low")r=3;var c={actionDueDate:i,actionCustomer:s,actionOwner:o.actionOwner,actionProgress:o.actionProgress,actionTopic:o.actionTopic,actionTask:o.actionTask,actionTitle:o.actionTitle,actionPriority:o.actionPriority,actionPriorityNumber:r,opptID_opportunityID:o.account};var u="/opportunityActionItems";var p=this.getView().getModel();p.create(u,c,{success:function(e,a){l.show("New Task created!");t.onCancelDialogPress()},error:function(e){sap.m.MessageBox.error("Task could not be created, check your input and try again.")}})}else this.ValueStateMethod()}else l.show("You have to select an account to link the task to first")},onDialogOpen:function(e){this.resetValueState();var t=this;if(!this._pDialog){this._pDialog=a.load({name:e,controller:this}).then(function(e){t.getView().addDependent(e);e.setEscapeHandler(function(){t.onCloseDialog()});return e})}this._pDialog.then(function(e){e.open()})},onCancelDialogPress:function(e){this._pDialog.then(function(e){e.close();e.destroy()});this._pDialog=null;var t=this.getView().getModel("AddTaskModel");t.setData({})},onListItemPress:function(e){var t=e.getSource().getBindingContext().getObject();var a=sap.ui.core.UIComponent.getRouterFor(this);a.navTo("TaskDetail",{ID:t.ID})},onSearch:function(e){var t=[];var a=e.getSource().getValue();if(a&&a.length>0){var t=[new n({filters:[new n({path:"actionTitle",operator:s.Contains,value1:a,caseSensitive:false}),new n({path:"actionTask",operator:s.Contains,value1:a,caseSensitive:false}),new n({path:"actionCustomer",operator:s.Contains,value1:a,caseSensitive:false}),new n({path:"actionTopic",operator:s.Contains,value1:a,caseSensitive:false}),new n({path:"actionOwner",operator:s.Contains,value1:a,caseSensitive:false})],and:false})]}var o=this.byId("myTaskTable").getTable();var i=o.getBinding("items");i.filter(t,u.Application)},onPopoverPress:function(e){var t=e.getSource(),o=this.getView(),n=e.getSource().getBindingContext().sPath;this._pPopover=a.load({id:o.getId(),name:"opportunity.opportunity.view.fragments.taskPopover.TaskPopover",controller:this}).then(function(e){o.addDependent(e);e.bindElement({path:n,events:{change:function(){e.invalidate()}}});return e});this._pPopover.then(function(e){e.attachAfterClose(function(){e.destroy()}.bind(this));e.openBy(t)})},onBeforeExportTasks:function(e){var t=e.getParameter("exportSettings").workbook;t.columns.unshift({property:"actionPriority",label:"Priority"});t.columns[5].label="Progress"},ValueStateMethod:function(e){var t=this.getView().getModel("valueState");l.show("Please fill all mandatory fields");t.setProperty("/valueState",c.Error);t.setProperty("/valueStateText","This field is mandatory")},resetValueState:function(e){var t=this.getView().getModel("valueState");t.setProperty("/valueState",c.None);t.setProperty("/valueStateText","")},onChangeValueState:function(e){var t=e.mParameters.newValue;if(t)this.resetValueState()}})});