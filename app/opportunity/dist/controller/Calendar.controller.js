sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/core/date/UI5Date","../model/formatter","sap/ui/core/Fragment","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,o,a,n,r,i,s,l){"use strict";return e.extend("opportunity.opportunity.controller.Calendar",{formatter:n,onInit:function(){sap.ui.core.UIComponent.getRouterFor(this).getRoute("Calendar").attachPatternMatched(this._onRoutePatternMatched,this);var e=new t({});this.getView().setModel(e,"CalendarModel");e.setProperty("/legendShown",false);var o=a.getInstance();e.setProperty("/startDate",o);var n=new t({editMode:false});this.getView().setModel(n,"editModel");var r=[];var i=[{text:"Sent for Proposal",type:"Type10"},{text:"RFP",type:"Type05"},{text:"On-Going",type:"Type01"},{text:"Go-Live",type:"Type08"},{text:"Past",type:"Type09"}];e.setProperty("/legendItems",r);e.setProperty("/legendAppointmentItems",i);var s=new t({});this.getView().setModel(s,"localModel")},handleAppointmentSelect:function(e){var t=e.getParameter("appointment"),a;if(t){a=t.getSelected()?"selected":"deselected";o.show("'"+t.getTitle()+"' "+a+". \n Selected appointments: "+this.byId("PC1").getSelectedAppointments().length)}else{var n=e.getParameter("appointments");var r=n.length+" Appointments selected";o.show(r)}},onProjectPopup:function(e){var t=e.getParameter("appointment");var o=e.getParameter("appointment").getBindingContext().sPath;var a=e.getParameter("appointment").getBindingContext().getObject().projectID;this.inumber=t.getBindingContext().getObject().userID_inumber;this.sProjectID=a;this.onDialogOpen("opportunity.opportunity.view.fragments.ViewProject",o,a)},onDialogOpen:function(e,t,o){var a=this.getView().getModel("editModel");a.setProperty("/editMode",false);var n=this;if(!this._pDialog){this._pDialog=r.load({name:e,controller:this}).then(function(e){n.getView().addDependent(e);e.setEscapeHandler(function(){n.onCloseDialog()});return e})}this._pDialog.then(function(e){if(t){e.setContentWidth("750px");e.setContentHeight("550px");e.bindElement({path:t,parameters:{expand:"comments,skills,tools"}});n.onFilterSkills(o);n.onFilterTools(o)}e.open()})},onFilterSkills(e){var t=sap.ui.getCore().byId("skillTokens");var o=sap.ui.getCore().byId("skillItem");var a=new sap.ui.model.Sorter("skill",false);var n=new s("projectID_projectID",l.EQ,e);t.bindAggregation("tokens",{template:o,path:"/skills",sorter:a,filters:n});t.updateBindings()},onFilterTools(e){var t=sap.ui.getCore().byId("toolTokens");var o=sap.ui.getCore().byId("toolItem");var a=new sap.ui.model.Sorter("tool",false);var n=new s("projectID_projectID",l.EQ,e);t.bindAggregation("tokens",{template:o,path:"/teamTools",sorter:a,filters:n});t.updateBindings()},onCancelDialogPress:function(e){this._pDialog.then(function(e){e.close();e.destroy()});this._pDialog=null;var t=this.getView().getModel("localModel");t.setData({})},onDeleteToken:function(e){var t=e.getParameter("token").getBindingContext().sPath;var o=this;o.getView().setBusy(true);var a=this.getView().getModel();sap.m.MessageBox.warning("Are you sure you want to delete this token for the project?",{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){a.remove(t,{success:function(){o.getView().setBusy(false);sap.m.MessageToast.show("Token deleted successfully.")},error:function(){o.getView().setBusy(false);sap.m.MessageToast.show("Token could not be deleted. Please try again.")}})}}})},onAddProjectSkill:function(e){this.onPopover("opportunity.opportunity.view.fragments.AddSkill",e)},onAddProjectTool:function(e){this.onPopover("opportunity.opportunity.view.fragments.AddTool",e)},onPopover:function(e,t){var o=t.getSource(),a=this.getView();this._pPopover=r.load({id:a.getId(),name:e,controller:this}).then(function(e){a.addDependent(e);return e});this._pPopover.then(function(e){e.openBy(o)})},onSubmitSkill:function(e){var t=this.getView().byId("skillInput");var o={skill:t.getValue(),userID_inumber:this.inumber,projectID_projectID:this.sProjectID};var a=this.getView().getModel();a.create("/skills",o,{success:function(e,o){i.show("New Skill added");t.setValue("")},error:function(e){sap.m.MessageBox.error("Skill could not be added, check your input and try again.")}})},onSubmitTool:function(e){var t=this.getView().byId("toolInput");var o={tool:t.getValue(),userID_inumber:this.inumber,projectID_projectID:this.sProjectID};var a=this.getView().getModel();a.create("/teamTools",o,{success:function(e,o){i.show("New Tool added");t.setValue("")},error:function(e){sap.m.MessageBox.error("Tool could not be added, check your input and try again.")}})},onEditProject:function(e){var t=sap.ui.getCore().byId("navContainer");var o=this.getView().getModel("editModel");var a=o.getProperty("/editMode");if(a){o.setProperty("/editMode",false);t.to("dynamicPageId","show")}else if(!a){o.setProperty("/editMode",true);t.to("dynamicPage2","show")}},onSaveProject:function(e){var t=this;var o=e.getSource().getParent().getBindingContext().getObject();var a=e.getSource().getParent().getBindingContext().sPath;var n,r,s;var l=sap.ui.getCore().byId("goLiveDate").getValue();var p=sap.ui.getCore().byId("projectDates").getDateValue();var d=sap.ui.getCore().byId("projectDates").getSecondDateValue();if(l)n=new Date(l).toISOString().split("T")[0];if(p)r=new Date(p).toISOString().split("T")[0];if(d)s=new Date(d).toISOString().split("T")[0];var c={goLive:n,projectContact:sap.ui.getCore().byId("projectContact").getValue(),marketUnit:sap.ui.getCore().byId("projectMU").getValue(),topic:sap.ui.getCore().byId("projectTopic").getValue(),projectStartDate:sap.ui.getCore().byId("projectDates").getDateValue(),projectEndDate:sap.ui.getCore().byId("projectDates").getSecondDateValue(),descriptionText:sap.ui.getCore().byId("projectDesc").getValue(),percentage:sap.ui.getCore().byId("projectPercentage").getValue(),lastUpdated:new Date,projectValue:sap.ui.getCore().byId("projectValue").getValue()};var g=this.getView().getModel();g.update(a,c,{success:function(){t.getView().setBusy(false);i.show(o.account+" updated successfully.");t.onEditProject()},error:function(e){i.show(e.message);t.getView().setBusy(false)}})},onAddVacation:function(e){this.onDialogOpen("opportunity.opportunity.view.fragments.AddVacation")},onMemberChange:function(e){e;var t=this.getView().getModel("localModel");var o=e.mParameters.selectedItem.getText();t.getData().firstName=o},onSubmitVacation:function(e){var t=this;var a=this.getView().getModel("localModel");var n=a.getData();var r;if(n.approved==true)r="Yes";else if(n.approved==false)r="No";var s={vacationStartDate:n.vacationStartDate,vacationEndDate:n.vacationEndDate,approved:r,vacationComment:n.vacationComment,primaryContact:n.firstName,userID_inumber:n.userID_inumber};t.getView().setBusy(true);var l=t.getView().getModel();l.create("/teamVacations",s,{success:function(e,o){i.show("New vacation added!");t.onCancelDialogPress();t.getView().setBusy(false)},error:function(e){t.getView().setBusy(false);o.error("Vacation could not be added. Please refresh and try again.")}})},onDateChange:function(e){var t=this.getView().getModel("localModel");var o=e.mParameters.newValue.split(" - ");var a=new Date(o[0]);var n=new Date(o[1]);var r=n-a;var i=Math.ceil(r/(1e3*60*60*24));console.log("Total vacation days:",i);t.getData().totalDays=i},onIntervalSelect:function(e){this.onPopover("opportunity.opportunity.view.fragments.AddTool",e)}})});