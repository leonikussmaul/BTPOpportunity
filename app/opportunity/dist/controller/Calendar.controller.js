sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/core/date/UI5Date","../model/formatter","sap/ui/core/Fragment","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/library"],function(e,t,o,a,r,n,i,s,l,d){"use strict";var p=d.ValueState,c={valueState:p.None,valueStateText:""};return e.extend("opportunity.opportunity.controller.Calendar",{formatter:r,onInit:function(){sap.ui.core.UIComponent.getRouterFor(this).getRoute("Calendar").attachPatternMatched(this._onRoutePatternMatched,this);this.getView().setModel(new sap.ui.model.json.JSONModel(c),"valueState");var e=new t({});this.getView().setModel(e,"CalendarModel");e.setProperty("/legendShown",false);var o=a.getInstance();e.setProperty("/startDate",o);var r=new t({editMode:false});this.getView().setModel(r,"editModel");var n=[];var i=[{text:"Sent for Proposal",type:"Type10"},{text:"RFP",type:"Type05"},{text:"On-Going",type:"Type01"},{text:"Go-Live",type:"Type08"},{text:"Past",type:"Type09"}];e.setProperty("/legendItems",n);e.setProperty("/legendAppointmentItems",i);var s=new t({});this.getView().setModel(s,"localModel")},handleAppointmentSelect:function(e){var t=e.getParameter("appointment"),a;if(t){a=t.getSelected()?"selected":"deselected";o.show("'"+t.getTitle()+"' "+a+". \n Selected appointments: "+this.byId("PC1").getSelectedAppointments().length)}else{var r=e.getParameter("appointments");var n=r.length+" Appointments selected";o.show(n)}},onProjectPopup:function(e){var t=e.getParameter("appointment");var o=e.getParameter("appointment").getBindingContext().sPath;var a=e.getParameter("appointment").getBindingContext().getObject().projectID;this.inumber=t.getBindingContext().getObject().userID_inumber;this.sProjectID=a;this.onDialogOpen("opportunity.opportunity.view.fragments.ViewProject",o,a)},onDialogOpen:function(e,t,o){this.resetValueState();var a=this.getView().getModel("editModel");a.setProperty("/editMode",false);var r=this;if(!this._pDialog){this._pDialog=n.load({name:e,controller:this}).then(function(e){r.getView().addDependent(e);e.setEscapeHandler(function(){r.onCloseDialog()});return e})}this._pDialog.then(function(e){if(t){e.setContentWidth("750px");e.setContentHeight("550px");e.bindElement({path:t,parameters:{expand:"comments,skills,tools"}});r.onFilterSkills(o);r.onFilterTools(o)}e.open()})},onFilterSkills(e){var t=sap.ui.getCore().byId("skillTokens");var o=sap.ui.getCore().byId("skillItem");var a=new sap.ui.model.Sorter("skill",false);var r=new s("projectID_projectID",l.EQ,e);t.bindAggregation("tokens",{template:o,path:"/skills",sorter:a,filters:r});t.updateBindings()},onFilterTools(e){var t=sap.ui.getCore().byId("toolTokens");var o=sap.ui.getCore().byId("toolItem");var a=new sap.ui.model.Sorter("tool",false);var r=new s("projectID_projectID",l.EQ,e);t.bindAggregation("tokens",{template:o,path:"/teamTools",sorter:a,filters:r});t.updateBindings()},onCancelDialogPress:function(e){this._pDialog.then(function(e){e.close();e.destroy()});this._pDialog=null;var t=this.getView().getModel("localModel");t.setData({})},onDeleteToken:function(e){var t=e.getParameter("token").getBindingContext().sPath;var o=this;var a=this.getView().getModel();sap.m.MessageBox.warning("Are you sure you want to delete this token for the project?",{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){a.remove(t,{success:function(){sap.m.MessageToast.show("Token deleted successfully.")},error:function(){sap.m.MessageToast.show("Token could not be deleted. Please try again.")}})}}})},onAddProjectSkill:function(e){this.onPopover("opportunity.opportunity.view.fragments.addFragments.AddSkill",e)},onAddProjectTool:function(e){this.onToolsPopover("opportunity.opportunity.view.fragments.addFragments.AddTool",e)},onPopover:function(e,t){var o=t.getSource(),a=this.getView();if(!this._pPopover){this._pPopover=n.load({name:e,controller:this}).then(function(e){a.addDependent(e);return e})}this._pPopover.then(function(e){e.openBy(o)})},onToolsPopover:function(e,t){var o=t.getSource(),a=this.getView();if(!this._tPopover){this._tPopover=n.load({name:e,controller:this}).then(function(e){a.addDependent(e);return e})}this._tPopover.then(function(e){e.openBy(o)})},onSubmitSkill:function(e){var t=this.getView().getModel("localModel");var o=t.getProperty("/skill");var a={skill:o,userID_inumber:this.inumber,projectID_projectID:this.sProjectID};var r=this.getView().getModel();r.create("/skills",a,{success:function(e,o){i.show("New Skill added");t.setData({})},error:function(e){sap.m.MessageBox.error("Skill could not be added, check your input and try again.")}})},onSubmitTool:function(e){var t=this.getView().getModel("localModel");var o=t.getProperty("/tool");var a={tool:o,userID_inumber:this.inumber,projectID_projectID:this.sProjectID};var r=this.getView().getModel();r.create("/teamTools",a,{success:function(e,o){i.show("New Tool added");t.setData({})},error:function(e){sap.m.MessageBox.error("Tool could not be added, check your input and try again.")}})},onEditProject:function(e){var t=sap.ui.getCore().byId("navContainer");var o=this.getView().getModel("editModel");var a=o.getProperty("/editMode");if(a){o.setProperty("/editMode",false);t.to("dynamicPageId","show")}else if(!a){o.setProperty("/editMode",true);t.to("dynamicPage2","show")}},onSaveProject:function(e){var t=this;var o=e.getSource().getParent().getBindingContext().getObject();var a=e.getSource().getParent().getBindingContext().sPath;var r,n,s;var l=sap.ui.getCore().byId("goLiveDate").getValue();var d=sap.ui.getCore().byId("projectDates").getDateValue();var p=sap.ui.getCore().byId("projectDates").getSecondDateValue();if(l)r=new Date(l).toISOString().split("T")[0];if(d)n=new Date(d).toISOString().split("T")[0];if(p)s=new Date(p).toISOString().split("T")[0];var c={goLive:r,projectContact:sap.ui.getCore().byId("projectContact").getValue(),marketUnit:sap.ui.getCore().byId("projectMU").getValue(),topic:sap.ui.getCore().byId("projectTopic").getValue(),projectStartDate:sap.ui.getCore().byId("projectDates").getDateValue(),projectEndDate:sap.ui.getCore().byId("projectDates").getSecondDateValue(),descriptionText:sap.ui.getCore().byId("projectDesc").getValue(),percentage:sap.ui.getCore().byId("projectPercentage").getValue(),lastUpdated:new Date,projectValue:sap.ui.getCore().byId("projectValue").getValue()};var u=this.getView().getModel();u.update(a,c,{success:function(){t.getView().setBusy(false);i.show(o.account+" updated successfully.");t.onEditProject()},error:function(e){i.show(e.message);t.getView().setBusy(false)}})},onAddVacation:function(e){this.onDialogOpen("opportunity.opportunity.view.fragments.addFragments.AddVacation")},onMemberChange:function(e){e;this.resetValueState();var t=this.getView().getModel("localModel");var o=e.mParameters.selectedItem.getText();t.getData().firstName=o},onSubmitVacation:function(e){var t=this;var a=this.getView().getModel("localModel");var r=a.getData();if(r.firstName&&r.vacationStartDate&&r.vacationEndDate){this.resetValueState();var n;if(r.approved==true)n="Yes";else if(r.approved==false)n="No";var s={vacationStartDate:r.vacationStartDate,vacationEndDate:r.vacationEndDate,approved:n,vacationComment:r.vacationComment,primaryContact:r.firstName,userID_inumber:r.userID_inumber};t.getView().setBusy(true);var l=t.getView().getModel();l.create("/teamVacations",s,{success:function(e,o){i.show("New vacation added!");t.onCancelDialogPress();t.getView().setBusy(false)},error:function(e){t.getView().setBusy(false);o.error("Vacation could not be added. Please refresh and try again.")}})}else this.ValueStateMethod()},onDateChange:function(e){this.resetValueState();var t=this.getView().getModel("localModel");var o=e.mParameters.newValue.split(" - ");var a=new Date(o[0]);var r=new Date(o[1]);var n=r-a;var i=Math.ceil(n/(1e3*60*60*24));console.log("Total vacation days:",i);t.getData().totalDays=i},ValueStateMethod:function(e){var t=this.getView().getModel("valueState");i.show("Please fill all mandatory fields");t.setProperty("/valueState",p.Error);t.setProperty("/valueStateText","This field is mandatory")},resetValueState:function(e){var t=this.getView().getModel("valueState");t.setProperty("/valueState",p.None);t.setProperty("/valueStateText","")},onChangeValueState:function(e){var t=e.mParameters.newValue;if(t)this.resetValueState()}})});