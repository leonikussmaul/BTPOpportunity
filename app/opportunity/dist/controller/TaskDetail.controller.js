sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/ui/core/ValueState","sap/ui/model/FilterType","../model/formatter","sap/ui/core/routing/History","sap/ui/core/date/UI5Date","sap/m/library"],function(e,t,s,a,o,i,n,r,u,d,l,g,c){"use strict";return e.extend("opportunity.opportunity.controller.TaskDetail",{formatter:d,onInit:function(){sap.ui.core.UIComponent.getRouterFor(this).getRoute("TaskDetail").attachPatternMatched(this._onRoutePatternMatched,this);var e=new a({editMode:false});this.getView().setModel(e,"editModel");var t=new a({});this.getView().setModel(t,"subTaskModel");var s=new a({});this.getView().setModel(s,"AddSubTaskModel");var o=new a({});this.getView().setModel(s,"editPageModel");var i=new a({});this.getView().setModel(i,"localModel")},_onRoutePatternMatched:function(e){var t=this.getView().getModel();this._sID=e.getParameter("arguments").ID;this.getView().bindElement({path:"/opportunityActionItems/"+this._sID,parameters:{expand:"subTasks"}});t.setDefaultBindingMode("TwoWay");this.onReadSubTasksData(this._sID);this.onFilterLinkList(this._sID);this.onFilterComments(this._sID)},onReadSubTasksData:function(e){var t=this;var s=this.getView().getModel();var a;if(e)a=e;else a=this.getView().getBindingContext().getObject().ID;var n=[];n.push(new o("opptID_ID",i.EQ,this._sID));var r=this.getView().getModel("subTaskModel");s.read("/opportunitySubTasks",{filters:n,sorters:[new sap.ui.model.Sorter("subTaskOrder",false)],success:function(e){var s=e.results;r.setProperty("/subtasks",s);var a=s.reduce(function(e,t){return t.subTaskCompleted?e:e+1},0);r.setProperty("/completedCount",a);t.onCompleteItems();t.updateCurrentIndex(s)}.bind(this),error:function(e){console.log(e)}})},onCompleteItems:function(e){var t=this.getView().byId("subTaskTable");t.getItems().forEach(e=>{if(e.getSelected())e.mAggregations.cells[1].addStyleClass("checkSubTask");else if(!e.getSelected())e.mAggregations.cells[1].removeStyleClass("checkSubTask")})},onNavBackPress:function(e){var s=sap.ui.core.UIComponent.getRouterFor(this);var a=this.getView().getModel();var o=l.getInstance();var i=o.getPreviousHash();var n=this.getView().getModel("editModel");var r=n.getProperty("/editMode");if(r){t.confirm("Discard changes and navigate back?",{onClose:function(e){if(e===t.Action.OK){n.setProperty("/editMode",false);if(a.hasPendingChanges()){a.resetChanges();a.updateBindings()}if(i!==undefined)window.history.go(-1);else s.navTo("TasksReport")}}.bind(this)})}else{if(i!==undefined)window.history.go(-1);else s.navTo("TasksReport")}},onAddSubTask:function(){var e=this;this.onDialogOpen("opportunity.opportunity.view.fragments.AddSubTask")},onSubmitNewSubTask:function(e){var s=this;var a=this.getView().getModel("AddSubTaskModel");var o=a.getData();var i=this.getView().getModel("subTaskModel").getData().subtasks.length;var r;if(o.subTaskStatus)r=o.subTaskStatus;else r="Not Started";var u=false;if(o.subTaskStatus==="Completed"){u=true}var d;if(o.subTaskDueDate)d=new Date(o.subTaskDueDate).toISOString().split("T")[0];var l={subTask:o.subTask,subTaskOwner:o.subTaskOwner,subTaskDueDate:d,opptID_ID:this._sID,subTaskCompleted:u,subTaskStatus:r,subTaskOrder:i};s.getView().setBusy(true);var g=s.getView().getModel();g.create("/opportunitySubTasks",l,{success:function(e,t){n.show("New sub-task added!");s.onReadSubTasksData();s.getView().setBusy(false);s.onCancelDialogPress()},error:function(e){s.getView().setBusy(false);t.error("Sub-task could not be added. Please check your input.")}})},onDialogOpen:function(e){var t=this;if(!this._pDialog){this._pDialog=s.load({name:e,controller:this}).then(function(e){t.getView().addDependent(e);e.setEscapeHandler(function(){t.onCloseDialog()});return e})}this._pDialog.then(function(e){e.open()})},onCancelDialogPress:function(e){this._pDialog.then(function(e){e.close();e.destroy()});this._pDialog=null;var t=this.getView().getModel("localModel");t.setData({});var s=this.getView().getModel("AddSubTaskModel");s.setData({})},onSelectSubTask:function(e){var t=this;t.getView().setBusy(true);var s=e.mParameters.listItems;s.forEach(e=>{var s;var a=e.getBindingContext().getObject();var o=e.getSelected();if(e.getBindingContext("subTaskModel")){s=e.getBindingContext("subTaskModel").getObject();var i="/opportunitySubTasks(guid'"+s.ID+"')";if(o===true){a.subTaskCompleted=true;a.subTaskStatus="Completed"}else{a.subTaskCompleted=false;a.subTaskStatus=s.subTaskStatus}var r={ID:s.ID,subTaskCompleted:a.subTaskCompleted,subTaskStatus:a.subTaskStatus};var u=this.getView().getModel();u.update(i,r,{success:function(){if(o===true){n.show("Sub-Task Completed")}t.onReadSubTasksData();t.getView().getModel("subTaskModel").refresh();t.getView().setBusy(false)},error:function(e){n.show(e.message);t.getView().setBusy(false)}})}})},onDeleteSubTasks:function(e){var t=this;var s=this.getView().byId("subTaskTable");var a=this.getView().getModel("subTaskModel");var o=s.getSelectedItems();if(o.length===0){sap.m.MessageToast.show("Complete at least one sub-task to delete");return}var i=this.getView().getModel();sap.m.MessageBox.warning("Are you sure you want to delete all the completed sub-tasks?",{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){var n=[];for(var r=o.length-1;r>=0;r--){var u=o[r].getBindingContext("subTaskModel").getObject();var d="/opportunitySubTasks(guid'"+u.ID+"')";var l=new Promise(function(e,o){i.remove(d,{success:function(o,n){i.refresh();a.refresh();t.onReadSubTasksData();a.updateBindings();s.updateBindings();s.removeSelections(true);e()},error:function(){o()}})});n.push(l)}Promise.all(n).then(function(){sap.m.MessageToast.show("All Sub-Tasks Completed!");t.onReadSubTasksData()}).catch(function(){sap.m.MessageToast.show("Some Sub-Tasks could not be deleted. Please try again later.");s.removeSelections(true)})}}})},onEditSubTask:function(e){var t=this;var s=e.getSource().getBindingContext("subTaskModel").getObject();var a=this.getView().getModel("AddSubTaskModel");if(s.subTaskDueDate){s.subTaskDueDate=s.subTaskDueDate.toISOString().split("T")[0]}a.setData(s);this.onDialogOpen("opportunity.opportunity.view.fragments.EditSubTask")},onSubmitEditedSubTask:function(e){var s=this;var a=this.getView().getModel("AddSubTaskModel");var o=a.getData();var i;if(o.subTaskStatus)i=o.subTaskStatus;else i="Not Started";var r=false;if(o.subTaskStatus==="Completed"){r=true}var u;if(o.subTaskDueDate)u=new Date(o.subTaskDueDate).toISOString().split("T")[0];var d={subTask:o.subTask,subTaskOwner:o.subTaskOwner,subTaskDueDate:u,subTaskStatus:i};s.getView().setBusy(true);var l=s.getView().getModel();var g="/opportunitySubTasks/"+a.getData().ID;l.update(g,d,{success:function(e,t){n.show("Sub-task updated!");s.onReadSubTasksData();s.getView().setBusy(false);s.onCancelDialogPress()},error:function(e){s.getView().setBusy(false);t.error("Sub-task could not be updated. Please check your input.")}})},onDeleteTaskObjectPress:function(e){var s=this;var a=e.getSource();var o=a.getBindingContext();var i=o.getPath();t.warning("Are you sure you want to delete this task?",{actions:[t.Action.OK,t.Action.CANCEL],emphasizedAction:t.Action.OK,onClose:function(e){if(e===t.Action.OK){var a=sap.ui.core.UIComponent.getRouterFor(s);a.navTo("TasksReport");s.getView().setBusy(true);var o=s.getView().getModel();o.remove(i,{success:function(){sap.m.MessageToast.show("Task deleted successfully.");s.getView().setBusy(false)},error:function(){sap.m.MessageToast.show("Task could not be deleted. Please try again.");s.getView().setBusy(false)}})}else{s.getView().setBusy(false)}}})},onSaveObjectPress:function(e){var s=this.getView().getModel();var a=this.getView().getModel("editModel");var o=this.getView().getModel("editPageModel");var i=o.getData();var r={actionTask:i.actionTask,actionTitle:i.actionTitle,actionOwner:i.actionOwner,actionProgress:this.getView().byId("actionProgressSlider").getValue(),actionDueDate:i.actionDueDate,actionPriority:i.actionPriority,actionPriorityNumber:i.actionPriorityNumber};var u=this.getView().getBindingContext().sPath;s.update(u,r,{success:function(){n.show("Changes saved successfully!");a.setProperty("/editMode",false)},error:function(e){t.error("Your changes could not be saved. Please try again.")}})},onCancelObjectPress:function(e){var t=e.getSource();var s=this.getView().getModel("editModel");s.setProperty("/editMode",false);var a=this.getView().getModel();a.resetChanges();a.updateBindings()},onEditObjectPress:function(e){var t=e.getSource();var s=this.getView().getModel("editModel");s.setProperty("/editMode",true);this.onSetEditPageModel()},onSetEditPageModel:function(){var e=this.getView().getBindingContext().getObject();var t=this.getView().getModel("editPageModel");t.setData(e)},onProgressSliderChange:function(e){var t=this.getView().getModel();var s=e.getParameter("value");var a=this.getView().getBindingContext();var o=a.getPath();t.setProperty(o+"/actionProgress",s)},onReorderUp:function(e){var t="Up";this.onReorderItems(e,t)},onReorderDown:function(e){var t="Down";this.onReorderItems(e,t)},onReorderItems:function(e,t){var s=this;var a=this.getView().getModel("subTaskModel");var o=a.getProperty("/subtasks");var i=e.getSource().getBindingContext("subTaskModel").getObject();var r=i.subTaskOrder;var u=r;if(t==="Up"&&r>0){u=r-1}else if(t==="Down"&&r<o.length-1){u=r+1}if(r!==u){o.splice(u,0,o.splice(r,1)[0]);o.forEach(function(e,t){if(e){e.subTaskOrder=t}});o=o.filter(function(e){return e!==undefined});a.setProperty("/subtasks",o);a.updateBindings();var d=this.getView().getModel();o.forEach(function(e,t){if(e){var a=e.ID;var i=e.subTaskOrder;var r="/opportunitySubTasks(guid'"+a+"')";var u={subTaskOrder:i};d.update(r,u,{success:function(){s.onCompleteItems();s.getView().getModel("subTaskModel").refresh()},error:function(e){n.show(e.message)}})}else{o.splice(t,1)}})}},onPopoverPress:function(e){var t=e.getSource(),a=this.getView(),o=e.getSource().getBindingContext("subTaskModel").sPath;this._pPopover=s.load({id:a.getId(),name:"opportunity.opportunity.view.fragments.TaskPopover2",controller:this}).then(function(e){a.addDependent(e);e.bindElement({path:"subTaskModel>"+o,events:{change:function(){e.invalidate()}}});return e});this._pPopover.then(function(e){e.attachAfterClose(function(){e.destroy()}.bind(this));e.openBy(t)})},onSubTaskStatusChange:function(e){var t=this;var s=this.getView().getModel();var a=e.getSource().getBindingContext("subTaskModel").getObject().ID;var o=e.getSource().getText();var i={subTaskStatus:o,subTaskCompleted:false};if(o==="Completed"){e.getSource().getParent().getParent().getParent().setSelected(true);i={subTaskStatus:o,subTaskCompleted:true}}var r="/opportunitySubTasks(guid'"+a+"')";s.update(r,i,{success:function(){n.show("Status changed to "+o);t.onCompleteItems();t.getView().getModel("subTaskModel").refresh()},error:function(e){n.show(e.message)}})},updateCurrentIndex:function(e){var t=this;var s=this.getView().getModel();var a=this.getView().byId("subTaskTable");var o=this.getView().getModel("subTaskModel");var e=this.getView().getModel("subTaskModel").getProperty("/subtasks");for(var i=0;i<e.length;i++){var r=e[i].ID;var u="/opportunitySubTasks(guid'"+r+"')";var d={subTaskOrder:i};s.update(u,d,{success:function(){a.updateBindings();o.updateBindings();s.refresh();t.getView().getModel("subTaskModel").refresh()},error:function(e){n.show(e.message)}})}},onGoToOpportunity:function(e){var t=this.getView().getBindingContext().getObject();var s=t.opptID_opportunityID;this.getOwnerComponent().getModel("userModel").setProperty("/opportunityID",s);var a=sap.ui.core.UIComponent.getRouterFor(this);a.navTo("ObjectPage",{opportunityID:s})},onSubTaskFilter:function(){var e=this.byId("subTaskTable");var t=e.getBinding("items");var s=this.getView().byId("subTaskFilter").getSelectedKey();var a;if(s==="Open"){a=new sap.ui.model.Filter("subTaskCompleted",sap.ui.model.FilterOperator.EQ,false)}else if(s==="Completed"){a=new sap.ui.model.Filter("subTaskCompleted",sap.ui.model.FilterOperator.EQ,true)}else{a=null}t.filter(a,sap.ui.model.FilterType.Application);this.onReadSubTasksData()},onFilterComments(e){var t=this.getView().byId("idTimeline");var s=this.getView().byId("timelineTasks");var a=new o("opptID_ID",i.EQ,e);t.bindAggregation("content",{template:s,path:"/opportunityTasksComments",filters:a})},onPostComment:function(e){var s=this;var a=e.mParameters.value;this.taskID=this.getView().getBindingContext().getObject().ID;var o=this.getOwnerComponent().getModel("user").getProperty("/firstname");var i={opptID_ID:this.taskID,comment:a,postedBy:o,postedOn:g.getInstance()};s.getView().setBusy(true);var r=s.getView().getModel();r.create("/opportunityTasksComments",i,{success:function(e,t){n.show("New comment added!");s.getView().setBusy(false)},error:function(e){s.getView().setBusy(false);t.error("Comment could not be posted. Please check your input.")}})},onDeleteTaskComment:function(e){var t=this;this.taskID=this.getView().getBindingContext().getObject().ID;var s=e.getSource().getParent().getBindingContext().sPath;t.getView().setBusy(true);var a=t.getView().getModel();a.remove(s,{success:function(){sap.m.MessageToast.show("Comment has been deleted");t.getView().setBusy(false)},error:function(){sap.m.MessageToast.show("Comment could not be deleted. Please try again.");t.getView().setBusy(false)}})},onAddNewLink:function(e){this.onDialogOpen("opportunity.opportunity.view.fragments.AddLink")},onSubmitNewLink:function(e){var s=this;var a=this.getView().getBindingContext().getObject().ID;var o=this.getView().getModel("localModel");var i=o.getData();var r={linkName:i.linkName,linkDescription:i.linkDescription,link:i.link,opptID_ID:a};s.getView().setBusy(true);var u=s.getView().getModel();u.create("/opportunityTasksLinks",r,{success:function(e,t){n.show("New Link added!");s.getView().setBusy(false);s.onFilterLinkList(a);s.onCancelDialogPress()},error:function(e){s.getView().setBusy(false);t.error("Link could not be posted. Please try again.")}})},onFilterLinkList:function(e){var t=this.getView().byId("linkListItem");var s=new sap.ui.model.Sorter("linkName",true);var a=new o("opptID_ID",i.EQ,e);this.getView().byId("linkList").bindAggregation("items",{template:t,path:"/opportunityTasksLinks",sorter:s,filters:a})},onDeleteLink:function(e){var s=this;var a=e.mParameters.listItem.getBindingContext();var o=a.getPath();var i=a.getObject("linkName");t.confirm("Are you sure you want to delete the link '"+i+"'?",function(e){if(e===t.Action.OK){s.getView().setBusy(true);var a=s.getView().getModel();a.remove(o,{success:function(){sap.m.MessageToast.show("Link deleted successfully.");s.getView().setBusy(false)},error:function(){sap.m.MessageToast.show("Link could not be deleted. Please try again.");s.getView().setBusy(false)}})}})},onSelectLink:function(e){var t=e.getSource().getBindingContext().getObject().link;c.URLHelper.redirect(t,true)}})});